<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Galgame聚合搜索</title>
  <!-- 引入 Bootstrap -->
  <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
  <!-- 引入 Font Awesome -->
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- 引入 animate.css 用于弹窗动画 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <style>
    :root {
      --main-bg: rgba(30, 30, 30, 0.85);
      --accent-color: #ff7eb9;
    }
    body {
      background: url('https://api.suyanw.cn/api/comic/api.php') no-repeat center fixed;
      background-size: cover;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
    }
    .container {
      background: var(--main-bg);
      backdrop-filter: blur(10px) saturate(180%);
      border-radius: 15px;
      padding: 2rem;
      margin-top: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      position: relative;
      margin-bottom: 40px; /* 下外边距 */
    }

    /* 移动端优化 */
    @media (max-width: 768px) {
      .container {
        width: 95%;
        margin: 1rem auto;
        padding: 1rem;
      }
      
      /* 输入框组垂直排列 */
      .input-group {
        flex-direction: column;
      }
      
      /* 输入框全宽 */
      #gameInput {
        width: 100% !important;
        font-size: 16px; /* 增大移动端字体 */
        padding: 12px;
      }
      
      /* 按钮全宽 */
      .search-btn {
        width: 100%;
        padding: 12px;
        margin-top: 8px;
      }
      
      /* 魔法模式调整 */
      .input-group-text {
        justify-content: center;
        padding: 8px;
      }
      
      /* 结果项文字大小 */
      .result-item h5 {
        font-size: 1rem;
      }
      
      /* 底部版权信息 */
      .footer {
        font-size: 0.8rem;
      }
      
      /* 平台导航栏 */
      .platform-nav {
        padding: 0 1rem 0.5rem;
      }
    }
    
    /* 添加移动端底部安全区域 */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      body {
        padding-bottom: env(safe-area-inset-bottom);
      }
    }

    /* 调整结果容器最大高度 */
    #results {
      max-height: 70vh;
      overflow-y: auto;
      margin: 1rem 0;
      padding: 0 8px;
    }

    /* 添加平台卡片内边距 */
    .platform-card {
      padding: 12px;
    }
    .platform-card:hover {
      transform: translateY(-3px);
    }
    .result-item {
      background: linear-gradient(45deg, rgba(50, 50, 50, 0.8), rgba(60, 60, 60, 0.8));
      border-radius: 8px;
      margin: 0.5rem 0;
      padding: 1rem;
      position: relative;
    }
    .url-box {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.3);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .search-btn {
      background: linear-gradient(45deg, #ff7eb9, #ff758c);
      border: none;
      transition: all 0.3s ease;
    }
    .search-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(255, 126, 185, 0.4);
    }
    /* 快速定位标签 */
    .platform-nav {
      overflow-x: auto;
      white-space: nowrap;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .platform-nav a {
      display: inline-block;
      margin-right: 1rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      text-decoration: none;
      transition: background 0.3s;
    }
    .platform-nav a:hover {
      background: rgba(0,0,0,0.5);
    }
    /* 底部版权信息 */
    .footer {
      text-align: center;
      margin-top: 2rem;
      color: #ccc;
      font-size: 0.9rem;
    }
    @media (max-width: 768px) {
      .container {
        margin: 1rem;
        padding: 1rem;
      }
      .input-group {
        flex-direction: column;
        gap: 0.5rem;
      }
      .input-group-text {
        justify-content: center;
      }
      .url-box {
        max-width: 70vw;
      }
    }

    .container.mt-3 {
      background: var(--main-bg);
      backdrop-filter: blur(10px) saturate(180%);
      border-radius: 15px;
      padding: 1rem 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      margin-top: 20px !important;
    }

    /* 折叠箭头动画 */
    [data-bs-toggle="collapse"] i {
      transition: transform 0.3s ease;
    }
    [data-bs-toggle="collapse"].collapsed i {
      transform: rotate(0deg);
    }
    [data-bs-toggle="collapse"]:not(.collapsed) i {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4 text-white fw-bold">
      <i class="fa-solid fa-gamepad me-2"></i>Galgame聚合搜索
    </h1>

    <div class="search-box mb-4">
      <div class="input-group">
        <input type="text" id="gameInput" class="form-control" 
               placeholder="输入游戏名称..." style="background: rgba(255,255,255,0.1); color: white;">
        <div class="input-group-text bg-transparent border-secondary">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="magicCheck" checked>
            <label class="form-check-label text-white" for="magicCheck" >魔法模式</label>
          </div>
        </div>
        <button class="btn search-btn text-white" onclick="doSearch()">
          <i class="fa-solid fa-magnifying-glass me-2"></i>搜索
        </button>
      </div>
    </div>

    <!-- 快速定位导航栏，默认隐藏 -->
    <div id="platformNav" class="platform-nav d-none"><br></div>

    <!-- 搜索结果区域 -->
    <div id="results" class="row g-3"></div>

    <!-- 底部版权信息 -->
    <div class="footer">
      2025/02/08 V3 | 
      
        <i class="fab fa-github"></i> <a href="https://github.com/Jurangren/SearchGal" target="_blank" style="color: #fff;">GitHub项目首页
      </a>
    </div>
    
  </div>

  

  <!-- 引入 jQuery -->
  <!-- <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script> -->
  <script src="./jquery.min.js"></script>
  <!-- 引入 SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
  
  <script>
    // 首次访问显示公告，带有动画效果
    $(document).ready(function() {
      Swal.fire({
        title: '✨ 使用须知 ✨',
        html: `<div style="text-align: left; color: #eee;">
                  <p>1. 本程序仅供学习交流使用，请支持正版游戏</p>
        <p>2. 本程序只用于搜索互联网平台上的内容，搜索结果来自第三方平台，请自行判断内容安全性</p>
        <p>3. 访问海外站点需要启用魔法搜索功能，请在服务端设置魔法(访客无需关注)</p>
        <p>4. 如果搜索词过短，部分平台的结果可能搜索不全(截取第一页结果)，因此尽量精确游戏名搜索</p>
        <p>5. 本程序每获取到请求后都会关闭与服务器的连接，本程序不提倡爆破/恶意爬取数据</p>
        <p>6. 如果遇到某个平台搜索失败, 检查你是否开了魔法, 也可能是平台炸了或者正则失效了</p>
        <p style='color:#1FD700'>平台标签绿色免登录可下载，金色需要魔法，白色需一定条件才能下载(例如登录/回复等)</p>
        <p style='color:#FFD700'>收录的大多是提供PC平台资源的网站，大部分平台都提供Onedrive或直链，两种方式比国内网盘下载速度更快</p>
        <p style='color:#FF6969'>请关闭浏览器的广告拦截插件, 或将各gal网站添加到白名单, 各网站建站不易, 这是对这些网站最基本支持</p>
        <center><p style='color:#FF6969'>有能力者请支持Galgame正版！</p></center>
        <center><small>觉得好用请前往<a href="https://github.com/Jurangren/SearchGal" target="_blank">Github项目</a>点一个免费的Star支持一下, 秋梨膏~!</small></center>
               </div>`,
        icon: 'info',
        confirmButtonText: '我已了解并认同上述观点',
        background: 'rgba(40,40,40,0.95)',
        confirmButtonColor: '#ff7eb9',
        customClass: {
          popup: 'animate__animated animate__zoomIn'
        }
      });
    });

    // 调整 url-box 的宽度（防止超出或折叠）
    function adjustUrlBox() {
      $('.url-box').each(function() {
        const $this = $(this);
        const parent = $this.closest('div[style*="min-width: 0"]');
        if (!parent.length) return;
        const tempSpan = $('<span>')
          .text($this.text())
          .css({
            'position': 'absolute',
            'visibility': 'hidden',
            'white-space': 'nowrap',
            'font': $this.css('font'),
            'padding': $this.css('padding'),
            'letter-spacing': $this.css('letter-spacing')
          })
          .appendTo('body');
        const textWidth = tempSpan.outerWidth();
        const parentWidth = parent.width();
        tempSpan.remove();
        $this.css('max-width', textWidth < parentWidth ? textWidth : parentWidth);
      });
    }
    let resizeTimer;
    $(window).on('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(adjustUrlBox, 100);
    });
    const observer = new MutationObserver(mutations => {
      adjustUrlBox();
      setTimeout(adjustUrlBox, 50);
    });
    observer.observe(document.getElementById('results'), { 
      childList: true, 
      subtree: true 
    });

    // 搜索函数
// 搜索函数
function doSearch() {
  const game = $('#gameInput').val().trim();
  if (!game) return;

  // 清空上次生成的快速定位导航栏
  $('#platformNav').empty().addClass('d-none');

  // 搜索中容器微小上拉，保持可视
  $('.container').css({
    'transform': 'translateY(-10%)', // 向上拉一点
    'margin-top': '0'
  });

  $('#results').html(`
    <div class="col-12 text-center text-white py-4">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <div class="mt-2">正在搜索中...</div>
    </div>
  `);

  // 修改搜索函数的post部分
  $.post('/search', { 
    game: game, 
    magic: $('#magicCheck').prop('checked'),
    ziyuan: $('#ziyuanPassword').val() // 添加新参数
  })
  .done(data => {
    let navHtml = '';
    let resultsHtml = '';
    // 遍历每个平台的结果
    data.results.forEach((platform, index) => {
      // 给每个平台设置一个锚点 id
      const platformId = 'platform-' + index;
      // 构造快速定位导航项（使用平台传递的颜色）
      navHtml += `<a href="#${platformId}" style="border: 1px solid ${platform.color};">
                    ${platform.name}
                  </a>`;
      // 检查是否有错误
      if (platform.error) {
        resultsHtml += `
          <div class="col-12">
            <div id="${platformId}" class="platform-card" style="color: ${platform.color};">
              <div class="card-header border-bottom-0" style="color: ${platform.color};">
                <i class="fa-solid fa-diamond me-2"></i>${platform.name}
                <span class="badge bg-danger float-end">错误</span>
              </div>
              <div class="card-body py-2">
                <div class="result-item">
                  <div class="d-flex justify-content-between align-items-center">
                    <div style="min-width: 0;">
                      <h5 class="text-white mb-2">${platform.error}</h5>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else {
        resultsHtml += `
          <div class="col-12">
            <div id="${platformId}" class="platform-card" style="color: ${platform.color};">
              <div class="card-header border-bottom-0" style="color: ${platform.color};">
                <i class="fa-solid fa-diamond me-2"></i>${platform.name}
                <span class="badge bg-dark float-end">${platform.items.length} 结果</span>
              </div>
              <div class="card-body py-2">
                ${platform.items.map(item => `
                  <div class="result-item">
                    <div class="d-flex justify-content-between align-items-center">
                      <div style="min-width: 0;">
                        <h5 class="text-white mb-2">${item.name}</h5>
                        <div class="url-box">
                          <small class="text-muted">${item.url}</small>
                        </div>
                      </div>
                      <button class="btn btn-sm btn-outline-light ms-3" 
                              onclick="window.open('${item.url}')"
                              style="flex-shrink: 0;">
                        <i class="fa-solid fa-arrow-up-right-from-square"></i>
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }
    });

    // 如果有平台数据，则显示快速定位导航栏
    if (navHtml) {
      $('#platformNav').html(navHtml).removeClass('d-none');
    }
    $('#results').html(resultsHtml || '<div class="col-12 text-center text-white py-4">没有找到相关结果</div>');
    
    // 搜索完成后，容器自适应，恢复到原始位置
    $('.container').css({
        'transform': 'translateY(-5%)', // 减少上移幅度
        'margin-top': '2rem'
      });

      // 结果加载完成后
      $('#results').html(resultsHtml || '<div class="col-12 text-center text-white py-4">没有找到相关结果</div>');
      
      // 添加结果容器边距
      $('#results').css({
        'margin-top': '1rem',
        'margin-bottom': '1rem'
      });

      // 恢复容器位置时添加过渡
      $('.container').css({
        'transform': 'translateY(0)',
        'margin-top': '2rem'
      });
  })
  .fail(() => {
    Swal.fire('错误', '搜索失败，请稍后重试', 'error');
    // 搜索失败时，恢复容器位置
    $('.container').css({
      'transform': 'translateY(0)',
      'margin-top': '20'
    });
  });
}
  // 监听输入框的回车键事件
  $('#gameInput').on('keypress', function(event) {
    if (event.key === 'Enter') {  // 判断是否按下的是回车键
      event.preventDefault();  // 防止回车键引发默认行为（如表单提交）
      $('.search-btn').click();  // 模拟点击搜索按钮
    }
  });

  let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if(isMobile) {
      $('#gameInput').attr('autocomplete', 'off');
      window.addEventListener('resize', function() {
        if(document.activeElement.tagName === 'INPUT') {
          window.scrollTo(0, 0);
        }
      });
    }
  </script>
</body>
</html>
